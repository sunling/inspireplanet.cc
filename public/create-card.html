<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆ›é€ ä½ çš„å¯å‘æ—¶åˆ»å¡ç‰‡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Add Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Import the new combined utility file as a module -->
    <script type="module" src="scripts/cardUtils.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&family=Playfair+Display&family=Montserrat&family=Lato&family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC&family=Noto+Serif+SC&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles/card-common.css" />
    <link rel="stylesheet" href="styles/card-gradients.css" />
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/page-specific.css" />
    <link rel="stylesheet" href="styles/utility.css" />
    <style>
      * {
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
      }

      body {
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        font-family: "PingFang SC", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
        background: linear-gradient(135deg, #f9f9f9, #e0eafc);
        min-height: 100vh;
        color: #333;
      }

      .main-content {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        padding: 30px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
        align-items: flex-start;
      }

      /* Preview */
      #preview {
        width: 460px;
        display: flex;
        justify-content: center;
        /* Center card horizontally */
        align-items: flex-start;
        /* Center card vertically */
        padding: 24px;
        border-radius: 16px;
        background: transparent;
        transition: all 0.3s ease;
      }

      /* Carousel */
      .latest-cards-section {
        margin-top: 40px;
        width: 100%;
      }

      .carousel-container {
        width: 100%;
        max-width: 1200px;
        /* margin: 0 auto; */
        /* padding: 20px 0; */
      }

      .swiper {
        width: 100%;
        padding-bottom: 40px;
      }

      .swiper-slide {
        display: flex;
        justify-content: center;
        align-items: center;
        /* padding: 10px; */
      }

      .carousel-card-wrapper {
        width: 100%;
        max-width: 420px;
        /* min-width: 300px; */
        box-sizing: border-box;
      }

      .swiper-pagination {
        bottom: 0;
      }

      .swiper-button-next,
      .swiper-button-prev {
        color: #4a6fa5;
      }

      .view-all-button-container {
        text-align: center;
        margin-top: 20px;
      }

      .view-all-button {
        display: inline-block;
        background-color: #ff7f50;
        /* æ©™è‰²ï¼Œå’Œæäº¤æŒ‰é’®ç»Ÿä¸€ */
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 16px;
        text-decoration: none;
        transition: transform 0.2s, background-color 0.2s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .view-all-button:hover {
        background-color: #ff9966;
        /* hoveræ—¶æ›´äº®ä¸€ç‚¹ */
        transform: scale(1.05);
      }

      .header-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        color: #444;
      }

      /* Footer */
      .page-footer {
        text-align: center;
        padding: 20px;
        font-size: 14px;
        margin-top: auto;
        color: #666;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        100% {
          background-position: 20px 20px, 20px 30px, 30px 10px, 10px 20px;
        }
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
          padding: 20px;
        }

        .form,
        #preview {
          width: 100%;
        }

        .carousel-card-wrapper {
          max-width: 90%;
        }

        .auth-section {
          position: static;
          margin-bottom: 10px;
          right: auto;
          display: flex;
          justify-content: center;
        }

        .login-buttons {
          justify-content: center;
        }

        .user-avatar-container {
          justify-content: center;
        }

        .gradient-selector {
          grid-template-columns: repeat(7, 1fr);
        }

        .gradient-option {
          width: 35px;
          height: 35px;
        }
      }
    </style>
    <link rel="stylesheet" href="styles/card-common.css" />
    <link rel="stylesheet" href="styles/card-gradients.css" />
    <link rel="stylesheet" href="styles/main.css" />
  </head>

  <body>
    <!-- Header Section -->
    <div class="container">
      <!-- Main Content -->
      <div class="main-content">
        <div class="form">
          <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ -->
          <div class="form-row">
            <div class="form-group flex-0-0-120">
              <label for="creator">åˆ›ä½œè€…</label>
              <input
                id="creator"
                placeholder="åŒ¿å"
                oninput="updateCardPreview()"
              />
            </div>
            <div class="form-group flex-1">
              <label for="title">æ ‡é¢˜</label>
              <input
                id="title"
                placeholder="è¿™ä¸€åˆ»ï¼Œæˆ‘æƒ³è¯´..."
                oninput="updateCardPreview()"
              />
            </div>
          </div>

          <!-- ç¬¬äºŒè¡Œï¼šè§¦åŠ¨ä½ çš„è§‚ç‚¹ -->
          <div class="form-group">
            <label for="quote"
              >è§¦åŠ¨ä½ çš„è§‚ç‚¹<small class="text-muted text-xs"
                >æŒ‰å›è½¦â†©ï¸æ¢è¡Œ</small
              ></label
            >
            <textarea
              id="quote"
              oninput="updateCardPreview()"
              placeholder="å†™ä¸‹è®©ä½ è§¦åŠ¨çš„ä¸€å¥è¯ã€ä¸€æ®µå¯¹è¯ã€æˆ–ä¸€ä¸ªç‰‡æ®µ..."
            ></textarea>
          </div>

          <!-- ç¬¬ä¸‰è¡Œï¼šä½ çš„å¯å‘ -->
          <div class="form-group">
            <label for="detail"
              >ä½ çš„å¯å‘<small class="text-muted text-xs"
                >æ”¯æŒ Markdown è¯­æ³•ï¼ŒæŒ‰å›è½¦â†©ï¸æ¢è¡Œ</small
              ></label
            >
            <textarea
              id="detail"
              oninput="updateCardPreview()"
              class="min-h-25 resize-vertical"
              placeholder="å†™ä¸‹ä½ çš„å¯å‘å’Œè¡ŒåŠ¨å§..."
            ></textarea>
            <div
              id="imageGenerationStatus"
              class="mt-1 text-sm text-secondary"
            ></div>
          </div>

          <!-- ç¬¬å››è¡Œï¼šé€‰æ‹©èƒŒæ™¯ -->
          <div class="form-group">
            <label for="choose-gradient">é€‰æ‹©èƒŒæ™¯</label>
            <div class="gradient-selector" id="gradient-selector">
              <div
                class="gradient-option selected"
                data-gradient="card-gradient-1"
                title="ğŸŒˆ å½©è™¹æ¢¦å¢ƒ"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-2"
                title="ğŸŒ… æ—¥å‡ºæš–é˜³"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-3"
                title="ğŸ’œ ç´«è‰²å¹»æƒ³"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-4"
                title="ğŸŒŠ æµ·æ´‹è“è°ƒ"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-5"
                title="ğŸ”¥ ç«ç„°æ©™é»„"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-6"
                title="ğŸŒ¿ æ¸…æ–°ç»¿æ„"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-7"
                title="â¤ï¸ çƒ­æƒ…çº¢æ©™"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-8"
                title="â˜ï¸ å¤©ç©ºè“ç™½"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-9"
                title="ğŸŒ«ï¸ é›¾éœ­ç°è“"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-10"
                title="ğŸ¯ èœ‚èœœæš–é»„"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-11"
                title="ğŸŒ± è–„è·æ¸…ç»¿"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-12"
                title="ğŸŒ¸ æ·¡é›…ç´«ç²‰"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-13"
                title="ğŸŒ¾ éº¦ç”°é‡‘é»„"
              ></div>
              <div
                class="gradient-option"
                data-gradient="card-gradient-14"
                title="ğŸŒ™ æœˆå…‰é“¶ç°"
              ></div>
            </div>
          </div>

          <!-- æœ€åä¸€è¡Œï¼šè‡ªå®šä¹‰æ’å›¾ã€æ‰¾å›¾æŒ‰é’®ã€é€‰æ‹©å­—ä½“ -->
          <div class="form-row mb-neg-9">
            <div class="form-group">
              <label for="bgUpload">è‡ªå®šä¹‰æ’å›¾</label>
              <div class="file-upload-wrapper">
                <button type="button" id="uploadBtn" class="upload-btn">
                  ğŸ“· é€‰æ‹©æœ¬åœ°å›¾ç‰‡</button
                ><br />
                <small id="fileStatus" class="text-muted ml-2 text-7px"></small>
                <input
                  type="file"
                  id="bgUpload"
                  accept="image/*"
                  class="hidden"
                />
              </div>
            </div>
            <label for="bgUpload">æˆ–è€…</label>
            <div class="form-group">
              <label>&nbsp;</label>
              <button
                type="button"
                id="searchImagesBtn"
                class="upload-btn min-w-120 p-2"
              >
                æ ¹æ®å¯å‘å†…å®¹æ‰¾å›¾ğŸ”
              </button>
            </div>
            <div class="form-group">
              <label for="choose-font">é€‰æ‹©å­—ä½“</label>
              <select id="choose-font" onchange="updateCardPreview()">
                <option value="'PingFang SC', sans-serif">è‹¹æ–¹</option>
                <option value="'Noto Sans SC', sans-serif">æ€æºé»‘ä½“</option>
                <option value="'Smiley Sans', sans-serif">å¾—æ„é»‘</option>
                <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿æ¯›ç¬”ä½“</option>
                <option value="'LXGW WenKai', serif">éœé¹œæ–‡æ¥·</option>
                <option value="'Alibaba PuHuiTi', sans-serif">
                  é˜¿é‡Œæ±‰ä»ªæ™ºèƒ½é»‘ä½“
                </option>
                <option value="'Noto Serif SC', serif">æ€æºå®‹ä½“</option>
                <option value="'KaiTi', serif">æ¥·ä½“</option>
              </select>
            </div>
          </div>

          <!-- è‡ªåŠ¨å›¾ç‰‡çŠ¶æ€æ˜¾ç¤º - éšè—æˆ–ç§»åˆ°ä¸æ˜æ˜¾ä½ç½® -->
          <div class="form-group hidden">
            <div
              id="autoImageStatus"
              class="text-center text-light opacity-70 text-10px"
            >
              æ­£åœ¨æ ¹æ®èƒŒæ™¯é¢œè‰²è‡ªåŠ¨åŒ¹é…å›¾ç‰‡...
            </div>
          </div>

          <!-- æœç´¢å›¾ç‰‡çŠ¶æ€å’Œç»“æœæ˜¾ç¤ºåŒº -->
          <!-- <div class="form-group"> -->
          <div
            id="searchImagesStatus"
            class="mt-neg-1 text-sm text-secondary"
          ></div>
          <!-- æœç´¢ç»“æœå›¾ç‰‡å±•ç¤ºåŒº -->
          <div id="searchImagesResults" class="hidden mt-neg-0-5">
            <h5 class="mb-2 text-base">
              æœç´¢ç»“æœï¼š<span id="searchQuery"></span>
            </h5>
            <div id="imageResults" class="flex flex-wrap gap-2"></div>
          </div>
          <!-- </div> -->

          <div class="buttons">
            <button onclick="submitCard()" class="primary-btn">
              æäº¤åˆ°å±•ç¤ºåŒº
            </button>
            <button onclick="downloadCardImage()">ä¸‹è½½å¡ç‰‡</button>
            <!-- <button onclick="shareToWechat()" class="upload-btn">ğŸ“± åˆ†äº«åˆ°å¾®ä¿¡</button> -->
          </div>
        </div>

        <div id="preview" class="animate__animated animate__fadeIn">
          <!-- å¡ç‰‡å†…å®¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
      </div>

      <!-- Latest Submitted Cards Section -->
      <div class="latest-cards-section">
        <h2>å±•ç¤ºåŒº</h2>
        <div class="carousel-container">
          <div class="swiper" id="latest-cards-swiper">
            <div class="swiper-wrapper" id="latest-cards">
              <!-- Cards will be loaded here -->
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
          </div>
        </div>
        <div class="view-all-button-container">
          <a href="cards" class="view-all-button">æµè§ˆæ›´å¤šçµæ„Ÿ</a>
        </div>
      </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <!-- Main script using ES modules -->
    <script type="module">
      // Import functions from cardUtils.js
      import {
        renderEditorCard,
        renderCarouselCard,
        downloadCard,
        uploadCard,
        fetchCards,
        onUploadBg,
        bindCustomFileUpload,
        getRandomItem,
        sanitizeAndValidateCard,
        processLongUrls,
      } from "./scripts/cardUtils.js";

      // Global variables
      window.customImage = "";
      window.currentGradientClass = "";
      window.selectedSearchImage = null;
      window.isLoadingAutoImage = false; // è·Ÿè¸ªè‡ªåŠ¨å›¾ç‰‡åŠ è½½çŠ¶æ€

      // å›¾ç‰‡ç¼“å­˜å¯¹è±¡
      const imageCache = {};

      let swiper;

      // æ¸å˜æ ·å¼æ•°ç»„
      // å¯¼å…¥å…±äº«çš„æ¸å˜é…ç½®
      import {
        gradientClasses,
        gradientFontColors,
        getFontColorForGradient,
        gradientSearchTerms,
      } from "./scripts/gradientConfig.js";

      // éšæœºé€‰æ‹©æ¸å˜èƒŒæ™¯
      function randomizeGradient() {
        const randomIndex = Math.floor(Math.random() * gradientClasses.length);
        window.currentGradientClass = gradientClasses[randomIndex];
        return window.currentGradientClass;
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–éšæœºæ¸å˜
        randomizeGradient();

        // åˆå§‹åŒ–æ¸å˜é€‰æ‹©å™¨
        initGradientSelector();

        // æ ¹æ®åˆå§‹èƒŒæ™¯é¢œè‰²è‡ªåŠ¨æœç´¢å›¾ç‰‡
        autoSearchImagesByGradient(window.currentGradientClass);

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¹¶å¡«å……åˆ›ä½œè€…ä¿¡æ¯
        checkUserLoginAndFillCreator();

        // Initial card render
        updateCardPreview();

        // Setup file upload
        setupFileUpload();

        // Load latest cards
        loadLatestCardsCarousel();

        // è‡ªåŠ¨èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
        setTimeout(() => {
          const titleInput = document.getElementById("title");
          if (titleInput) {
            titleInput.focus();
          }
        }, 500);
      });

      // åˆå§‹åŒ–æ¸å˜é€‰æ‹©å™¨
      function initGradientSelector() {
        const gradientOptions = document.querySelectorAll(".gradient-option");

        // è®¾ç½®é»˜è®¤é€‰ä¸­çŠ¶æ€
        gradientOptions.forEach((option) => {
          option.classList.remove("selected");
          if (option.dataset.gradient === window.currentGradientClass) {
            option.classList.add("selected");
          }
        });

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        gradientOptions.forEach((option) => {
          option.addEventListener("click", function () {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            gradientOptions.forEach((opt) => opt.classList.remove("selected"));
            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            this.classList.add("selected");
            // æ›´æ–°å½“å‰æ¸å˜ç±»
            window.currentGradientClass = this.dataset.gradient;
            // æ ¹æ®æ–°é€‰æ‹©çš„èƒŒæ™¯é¢œè‰²è‡ªåŠ¨æœç´¢å›¾ç‰‡
            autoSearchImagesByGradient(window.currentGradientClass);
            // æ›´æ–°å¡ç‰‡é¢„è§ˆ
            updateCardPreview();
          });
        });
      }

      // Function to handle gradient selection (ä¿æŒå‘åå…¼å®¹)
      window.updateGradientSelection = function () {
        // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸»è¦ç”¨äºå‘åå…¼å®¹ï¼Œå®é™…åŠŸèƒ½ç”±initGradientSelectorå¤„ç†
        updateCardPreview();
      };

      // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¹¶å¡«å……åˆ›ä½œè€…ä¿¡æ¯
      function checkUserLoginAndFillCreator() {
        const jwt = localStorage.getItem('jwt') || localStorage.getItem('userToken');
        const userInfo = localStorage.getItem('userInfo');
        
        if (jwt && userInfo) {
          try {
            const user = JSON.parse(userInfo);
            const creatorInput = document.getElementById('creator');
            if (creatorInput && user.name) {
              creatorInput.value = user.name;
              creatorInput.placeholder = user.name;
              // æ›´æ–°å¡ç‰‡é¢„è§ˆ
              updateCardPreview();
            }
          } catch (error) {
            console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          }
        }
      }

      // Function to submit a card
      window.submitCard = function () {
        // ç¡®ä¿ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ¸å˜èƒŒæ™¯ï¼ˆä»é€‰ä¸­çš„å°æ–¹å—è·å–ï¼‰
        const selectedOption = document.querySelector(
          ".gradient-option.selected"
        );
        if (selectedOption) {
          window.currentGradientClass = selectedOption.dataset.gradient;
        }

        uploadCard({
          gradientClass: window.currentGradientClass,
          font: document.getElementById("choose-font").value,
          title: document.getElementById("title").value,
          quote: document.getElementById("quote").value,
          imagePath: "",
          detail: document.getElementById("detail").value,
          creator: document.getElementById("creator").value,
          upload: customImage,
          searchImageSelected:
            document.getElementById("quote-image-preview-card").src || "",
        }).then((result) => {
          if (result) {
            // Refresh latest cards carousel
            loadLatestCardsCarousel();
          }
        });
      };

      window.updateCardPreview = function (uploadImg) {
        // If uploadImg is provided, update the customImage variable
        if (uploadImg) {
          customImage = uploadImg;
        }

        // è·å–è¯¦æƒ…å†…å®¹å¹¶è½¬æ¢Markdownä¸ºHTML
        const detailText =
          document.getElementById("detail").value || "è¯·å¡«å†™ä½ çš„å¯å‘å’Œè¡ŒåŠ¨";

        // é…ç½®markedï¼Œå¯ç”¨æ¢è¡Œé€‰é¡¹
        marked.setOptions({
          breaks: true, // å°†å•ä¸ªæ¢è¡Œç¬¦è§£æä¸º<br>
        });

        // ä½¿ç”¨marked.jsè§£æMarkdown
        const parsedDetail = detailText ? marked.parse(detailText) : "";

        const options = {
          title: document.getElementById("title").value || "è¿™ä¸€åˆ»ï¼Œæˆ‘æƒ³è¯´...",
          quote:
            document.getElementById("quote").value || "è¯·å†™ä¸‹è§¦åŠ¨åˆ°ä½ çš„è§‚ç‚¹",
          detail: parsedDetail, // ä½¿ç”¨è§£æåçš„HTML
          imagePath: "",
          creator: document.getElementById("creator").value || "åŒ¿å",
          font:
            document.getElementById("choose-font").value ||
            `'Noto Sans SC', sans-serif`,
          gradientClass: window.currentGradientClass,
          customImage: customImage,
          created: new Date().toISOString(), // æ·»åŠ å½“å‰æ—¶é—´
          isMarkdown: true, // æ ‡è®°ä½¿ç”¨äº†Markdown
        };

        // ä¼˜å…ˆçº§ï¼šæœç´¢é€‰ä¸­çš„å›¾ç‰‡ > è‡ªå®šä¹‰ä¸Šä¼ çš„å›¾ç‰‡ > åŠ è½½çŠ¶æ€æ˜¾ç¤º
        // æ£€æŸ¥æ˜¯å¦æœ‰çœŸæ­£é€‰æ‹©çš„æœç´¢ç»“æœå›¾ç‰‡ï¼ˆé€šè¿‡ç‰¹å®šçš„æ ‡è¯†æ¥åˆ¤æ–­ï¼‰
        const searchSelectedImage = window.selectedSearchImage || "";
        let finalImage = searchSelectedImage || customImage;

        // å¦‚æœæ­£åœ¨åŠ è½½è‡ªåŠ¨å›¾ç‰‡ä¸”æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€è€Œä¸æ˜¯å†…ç½®å›¾ç‰‡
        if (window.isLoadingAutoImage && !finalImage) {
          finalImage = null; // ä¸æ˜¾ç¤ºä»»ä½•å›¾ç‰‡ï¼Œç¨åä¼šæ·»åŠ åŠ è½½æç¤º
        } else if (!finalImage) {
          finalImage = ""; // æ²¡æœ‰å†…ç½®å›¾ç‰‡é€‰æ‹©åŠŸèƒ½
        }
        // æ ¼å¼åŒ–å½“å‰æ—¶é—´
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const currentTime = `${now.getFullYear()}-${pad(
          now.getMonth() + 1
        )}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(
          now.getMinutes()
        )}`;

        // è·å–å½“å‰æ¸å˜å¯¹åº”çš„å­—ä½“é¢œè‰²
        const fontColor = getFontColorForGradient(window.currentGradientClass);
        const quoteBoxBg = "rgba(255, 255, 255, 0.9)";
        const cardHTML = `
        <div class="card ${window.currentGradientClass}" style="
              font-family: ${options.font};
              color: ${fontColor};
            ">
           <div class="card-body">
            <div class="title">${options.title}</div>
            <div class="quote-box" style="
              background-color: ${quoteBoxBg}; 
              color: ${fontColor};
            ">${options.quote}</div>
            ${
              finalImage
                ? `<img id="quote-image-preview-card" src="${finalImage}" alt="Card Image" crossorigin="anonymous" />`
                : window.isLoadingAutoImage
                ? `<div class="image-loading-placeholder" style="
              width: 100%;
              height: 200px;
              background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
              background-size: 20px 20px;
              background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #666;
              font-size: 14px;
              animation: shimmer 2s infinite;
            ">æ­£åœ¨ä¸ºæ‚¨åŒ¹é…å›¾ç‰‡...</div>`
                : ""
            }
            <div class="detail-text">${processLongUrls(options.detail)}</div>
          </div>
          <div class="card-footer">
            <div class="footer" style="color: ${fontColor}">â€”â€”ä½œè€…ï¼š${
          options.creator
        } Â· ${currentTime}</div>
          </div>
        </div>
      `;

        // Clear the preview container and append the new card
        const previewContainer = document.getElementById("preview");
        previewContainer.innerHTML = cardHTML;
      };

      // Function to download the current card
      window.downloadCardImage = function () {
        downloadCard(".card", "inspiration-card-");
      };

      // Setup file upload functionality
      function setupFileUpload() {
        const bgUpload = document.getElementById("bgUpload");
        const uploadBtn = document.getElementById("uploadBtn");
        const fileStatus = document.getElementById("fileStatus");

        if (!bgUpload || !uploadBtn || !fileStatus) {
          console.warn("ä¸Šä¼ åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼šå…ƒç´ æœªæ‰¾åˆ°");
          return;
        }

        // ç›´æ¥ç»‘å®šä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        uploadBtn.addEventListener("click", () => {
          bgUpload.click();
        });

        // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
        bgUpload.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            customImage = e.target.result;
            // æ¸…é™¤æœç´¢é€‰ä¸­çš„å›¾ç‰‡ï¼Œé¿å…å†²çª
            window.selectedSearchImage = null;
            fileStatus.textContent = "å·²ä¸Šä¼ ï¼š" + file.name;
            updateCardPreview(customImage); // ç¡®ä¿ä¼ é€’å›¾ç‰‡æ•°æ®
            event.target.value = ""; // æ¸…ç©ºå€¼ä»¥æ”¯æŒé‡å¤ä¸Šä¼ 
          };
          reader.readAsDataURL(file);
        });
      }

      // Load and render latest cards to carousel
      async function loadLatestCardsCarousel() {
        const container = document.getElementById("latest-cards");
        if (!container) return;

        // Show loading indicator
        container.innerHTML =
          '<div class="swiper-slide"><div class="loading-indicator">åŠ è½½ä¸­...</div></div>';

        try {
          const cards = await fetchCards();

          if (!cards || cards.length === 0) {
            container.innerHTML =
              '<div class="swiper-slide"><div class="loading-indicator">æš‚æ— å¡ç‰‡æ•°æ®</div></div>';
            return;
          }

          // Clear loading indicator
          container.innerHTML = "";

          // Filter valid cards and limit to 20
          const validCards = cards
            .filter((card) => card && card.Title && card.Quote)
            .map((card) =>
              sanitizeAndValidateCard(card, [
                "Font",
                "Title",
                "Quote",
                "Detail",
                "ImagePath",
                "Creator",
              ])
            )
            .filter((result) => result.isValid)
            .map((result) => result.sanitizedCard);
          const recentCards = validCards.slice(0, 20);

          // Render each card
          recentCards.forEach((card, index) => {
            const cardElement = renderCarouselCard(card, index);
            cardElement.style.cursor = "pointer";
            cardElement.addEventListener("click", () => {
              window.location.href = `card-detail?id=${card.id}`;
            });
            container.appendChild(cardElement);
          });

          // Initialize or update Swiper
          initOrUpdateSwiper();
        } catch (error) {
          console.error("åŠ è½½æœ€æ–°å¡ç‰‡å¤±è´¥:", error);
          container.innerHTML =
            '<div class="swiper-slide"><div class="loading-indicator">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div></div>';
        }
      }

      // Initialize or update Swiper
      function initOrUpdateSwiper() {
        if (swiper) {
          swiper.update();
        } else {
          swiper = new Swiper("#latest-cards-swiper", {
            slidesPerView: 1,
            spaceBetween: 30,
            loop: true,
            centeredSlides: true,
            autoplay: {
              delay: 5 * 60 * 1000,
              disableOnInteraction: true,
            },
            pagination: {
              el: ".swiper-pagination",
              clickable: true,
            },
            navigation: {
              nextEl: ".swiper-button-next",
              prevEl: ".swiper-button-prev",
            },
            breakpoints: {
              640: {
                slidesPerView: 1,
              },
              768: {
                slidesPerView: 2,
              },
              1024: {
                slidesPerView: 3,
              },
            },
          });
        }
      }
      // æ ¹æ®æ¸å˜èƒŒæ™¯é¢œè‰²è‡ªåŠ¨æœç´¢å›¾ç‰‡
      async function autoSearchImagesByGradient(gradientClass) {
        const statusDiv = document.getElementById("autoImageStatus");
        const resultsDiv = document.getElementById("autoImageResults");
        const imageGridDiv = document.getElementById("autoImageGrid");

        const searchTerm =
          gradientSearchTerms[gradientClass] || "abstract colorful";

        try {
          // æ£€æŸ¥ç¼“å­˜
          if (
            imageCache[gradientClass] &&
            imageCache[gradientClass].length > 0
          ) {
            // ä»ç¼“å­˜ä¸­éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
            const cachedImages = imageCache[gradientClass];
            const randomIndex = Math.floor(Math.random() * cachedImages.length);
            const selectedImage = cachedImages[randomIndex];

            // è®¾ç½®é€‰ä¸­çš„å›¾ç‰‡
            window.selectedSearchImage = selectedImage.url;
            window.customImage = null;
            window.isLoadingAutoImage = false;

            // æ˜¾ç¤ºç¼“å­˜çš„å›¾ç‰‡
            displayImages(
              cachedImages,
              randomIndex,
              statusDiv,
              resultsDiv,
              imageGridDiv
            );

            // æ›´æ–°çŠ¶æ€
            statusDiv.textContent = "å·²ä»ç¼“å­˜åŠ è½½å›¾ç‰‡";

            // æ›´æ–°å¡ç‰‡é¢„è§ˆ
            updateCardPreview();
            return;
          }

          // è®¾ç½®åŠ è½½çŠ¶æ€
          window.isLoadingAutoImage = true;
          window.selectedSearchImage = null;
          window.customImage = null;

          // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå’Œå¡ç‰‡é¢„è§ˆ
          if (statusDiv)
            statusDiv.textContent = "æ­£åœ¨æ ¹æ®èƒŒæ™¯é¢œè‰²è‡ªåŠ¨åŒ¹é…å›¾ç‰‡...";
          if (resultsDiv) resultsDiv.style.display = "none";
          updateCardPreview(); // ç«‹å³æ›´æ–°é¢„è§ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€

          // è°ƒç”¨æœç´¢API
          const response = await fetch("/.netlify/functions/searchImage", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              text: searchTerm,
              orientation: "landscape",
            }),
          });

          const data = await response.json();

          if (response.ok && data.images && data.images.length > 0) {
            // ç¼“å­˜å›¾ç‰‡æ•°æ®
            imageCache[gradientClass] = data.images;

            // æ¸…é™¤åŠ è½½çŠ¶æ€å¹¶éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
            window.isLoadingAutoImage = false;
            const randomIndex = Math.floor(Math.random() * data.images.length);
            const selectedImage = data.images[randomIndex];
            window.selectedSearchImage = selectedImage.url;
            window.customImage = null; // æ¸…é™¤è‡ªå®šä¹‰ä¸Šä¼ çš„å›¾ç‰‡

            // æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡ä¾›ç”¨æˆ·é€‰æ‹©ï¼ˆå¦‚æœæ˜¾ç¤ºå…ƒç´ å­˜åœ¨ï¼‰
            if (statusDiv && resultsDiv && imageGridDiv) {
              displayImages(
                data.images,
                randomIndex,
                statusDiv,
                resultsDiv,
                imageGridDiv
              );
            }

            // æ›´æ–°çŠ¶æ€
            if (statusDiv) statusDiv.textContent = "";

            // æ›´æ–°å¡ç‰‡é¢„è§ˆ
            updateCardPreview();
          } else {
            // æ¸…é™¤åŠ è½½çŠ¶æ€
            window.isLoadingAutoImage = false;
            if (statusDiv) statusDiv.textContent = "æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡";
            window.selectedSearchImage = null;
            window.customImage = null;
            updateCardPreview();
          }
        } catch (error) {
          // æ¸…é™¤åŠ è½½çŠ¶æ€
          window.isLoadingAutoImage = false;
          console.error("è‡ªåŠ¨æœç´¢å›¾ç‰‡å¤±è´¥:", error);
          if (statusDiv) statusDiv.textContent = "è‡ªåŠ¨æœç´¢å›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•";
          window.selectedSearchImage = null;
          window.customImage = null;
          updateCardPreview();
        }
      }

      // æ˜¾ç¤ºå›¾ç‰‡çš„è¾…åŠ©å‡½æ•°
      function displayImages(
        images,
        selectedIndex,
        statusDiv,
        resultsDiv,
        imageGridDiv
      ) {
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        imageGridDiv.innerHTML = "";

        images.forEach((image, index) => {
          const imgContainer = document.createElement("div");
          imgContainer.style.width = "calc(33.33% - 10px)";
          imgContainer.style.position = "relative";
          imgContainer.style.cursor = "pointer";
          imgContainer.style.borderRadius = "8px";
          imgContainer.style.overflow = "hidden";
          imgContainer.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";

          // é€‰ä¸­çš„å›¾ç‰‡é«˜äº®æ˜¾ç¤º
          if (index === selectedIndex) {
            imgContainer.style.border = "3px solid #4a6fa5";
          }

          const img = document.createElement("img");
          img.src = image.thumb;
          img.alt = image.title;
          img.style.width = "100%";
          img.style.height = "100px";
          img.style.objectFit = "cover";

          const overlay = document.createElement("div");
          overlay.style.position = "absolute";
          overlay.style.bottom = "0";
          overlay.style.left = "0";
          overlay.style.right = "0";
          overlay.style.backgroundColor = "rgba(0,0,0,0.6)";
          overlay.style.color = "white";
          overlay.style.padding = "4px";
          overlay.style.fontSize = "10px";
          overlay.textContent = image.description;

          imgContainer.appendChild(img);
          imgContainer.appendChild(overlay);

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          imgContainer.addEventListener("click", () => {
            window.selectedSearchImage = image.url;
            window.customImage = null;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll("#autoImageGrid > div").forEach((div) => {
              div.style.border = "none";
            });
            imgContainer.style.border = "3px solid #4a6fa5";

            // æ›´æ–°å¡ç‰‡é¢„è§ˆ
            updateCardPreview();
          });

          imageGridDiv.appendChild(imgContainer);
        });

        // æ˜¾ç¤ºç»“æœ
        resultsDiv.style.display = "block";
      }

      // Function to search for images based on inspiration content
      async function searchImagesFromDetail() {
        // Get content from all three fields
        const titleText = document.getElementById("title").value || "";
        const quoteText = document.getElementById("quote").value || "";
        const detailText = document.getElementById("detail").value || "";

        // Check if at least one field has content
        if (!titleText && !quoteText && !detailText) {
          alert("è¯·å…ˆè¾“å…¥æ ‡é¢˜ã€å¼•ç”¨æˆ–å¯å‘å†…å®¹");
          return;
        }

        const searchBtn = document.getElementById("searchImagesBtn");
        const statusDiv = document.getElementById("searchImagesStatus");
        const resultsDiv = document.getElementById("searchImagesResults");
        const querySpan = document.getElementById("searchQuery");
        const imageResultsDiv = document.getElementById("imageResults");

        try {
          // Update UI to show loading state
          searchBtn.disabled = true;
          statusDiv.textContent = "æ­£åœ¨æœç´¢ç›¸å…³å›¾ç‰‡ï¼Œè¯·ç¨å€™...";
          resultsDiv.style.display = "none";

          // Combine all three fields for searching
          const combinedText = [titleText, quoteText, detailText]
            .filter((text) => text.trim())
            .join(" ");

          // Call the Netlify function
          const response = await fetch("/.netlify/functions/searchImage", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              text: combinedText,
              orientation: "landscape",
            }),
          });

          const data = await response.json();

          if (response.ok) {
            // Display the search query
            querySpan.textContent = data.query;

            // Clear previous results
            imageResultsDiv.innerHTML = "";

            // Display the images
            if (data.images && data.images.length > 0) {
              data.images.forEach((image) => {
                const imgContainer = document.createElement("div");
                imgContainer.style.width = "calc(33.33% - 10px)";
                imgContainer.style.position = "relative";
                imgContainer.style.cursor = "pointer";
                imgContainer.style.borderRadius = "8px";
                imgContainer.style.overflow = "hidden";
                imgContainer.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";

                const img = document.createElement("img");
                img.src = image.thumb;
                img.alt = image.title;
                img.style.width = "100%";
                img.style.height = "100px";
                img.style.objectFit = "cover";

                const overlay = document.createElement("div");
                overlay.style.position = "absolute";
                overlay.style.bottom = "0";
                overlay.style.left = "0";
                overlay.style.right = "0";
                overlay.style.backgroundColor = "rgba(0,0,0,0.6)";
                overlay.style.color = "white";
                overlay.style.padding = "4px";
                overlay.style.fontSize = "10px";
                overlay.textContent = image.description;

                imgContainer.appendChild(img);
                imgContainer.appendChild(overlay);

                // Add click event to select this image
                imgContainer.addEventListener("click", () => {
                  // è®¾ç½®é€‰ä¸­çš„æœç´¢å›¾ç‰‡
                  window.selectedSearchImage = image.url;
                  // æ¸…é™¤è‡ªå®šä¹‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œé¿å…å†²çª
                  customImage = null;
                  // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                  const fileStatus = document.getElementById("fileStatus");
                  if (fileStatus) {
                    fileStatus.textContent = "å·²é€‰æ‹©æœç´¢ç»“æœå›¾ç‰‡";
                  }
                  // Update the card preview
                  updateCardPreview();
                  // Add a highlight to the selected image
                  document
                    .querySelectorAll("#imageResults > div")
                    .forEach((div) => {
                      div.style.border = "none";
                    });
                  imgContainer.style.border = "3px solid #4a6fa5";
                });

                imageResultsDiv.appendChild(imgContainer);
              });

              // Show the results
              resultsDiv.style.display = "block";
              statusDiv.textContent = ""; // Clear status message
            } else {
              statusDiv.textContent = "æœªæ‰¾åˆ°ç›¸å…³å›¾ç‰‡ï¼Œè¯·å°è¯•ä¿®æ”¹å¯å‘å†…å®¹ã€‚";
            }
          } else {
            throw new Error(data.error || "æœç´¢å›¾ç‰‡å¤±è´¥");
          }
        } catch (error) {
          console.error("Error searching images:", error);
          statusDiv.textContent = `æœç´¢å¤±è´¥: ${error.message}`;
        } finally {
          searchBtn.disabled = false;
        }
      }

      // Add event listener for the search images button
      document
        .getElementById("searchImagesBtn")
        .addEventListener("click", searchImagesFromDetail);
    </script>

    <!-- Floating Action Buttons -->
    <div id="floating-actions-placeholder"></div>

    <script src="/scripts/layout.js"></script>
    <script src="/shared/floating-actions-loader.js"></script>
  </body>
</html>
